<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Serverless Build Status</title>
    <style>
        #build-status-table {
            background-color: #e0e0e0;
            width: 100%;
        }
        #build-status-table tr:nth-child(even) {
            background-color: #c0c0c0;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css" />
</head>
<body>
<div>
    <h1>Release Build Status</h1>
    <table>
        <tr>
            <td>
                <label for="pat">Personal Access token</label>
            </td>
            <td>
                <input type="password" name="pat" id="pat"/>
                (create a fine-grained token without permissions for public repositories <a
                    href="https://github.com/settings/tokens" target="_blank">here</a>)
            </td>
        </tr>
        <tr>
            <td>
                <label for="branches">Branches</label>
            </td>
            <td>
                <input type="text" name="branches" id="branches"/>
                (Comma separated list of branches to filter on, all by default, for example <code>release-1.35,release-v1.15</code>)
            </td>
        </tr>
    </table>
    <br/>
    <button type="button" id="trigger">Run</button>
    <table id="build-status-table">
        <thead>
        <tr>
            <th>Branch</th>
            <th>Repository</th>
            <th>Run Name</th>
            <th>Status</th>
            <th>Started</th>
            <th>Trigger retest</th>
            <th>Run</th>
            <th>Latest Commit</th>
            <th>Last Success Commit</th>
        </tr>
        </thead>
    </table>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"
        integrity="sha512-CSBhVREyzHAjAFfBlIBakjoRUKp5h7VSweP0InR/pAJyptH7peuhCsqAI/snV+TwZmXZqoUklpXp6R6wMnYf5Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
<script>
    const baseConfigURL = 'https://raw.githubusercontent.com/openshift-knative/hack/refs/heads/main/config';
    document.getElementById('trigger').addEventListener('click', async e => {
        const urlParams = new URLSearchParams(window.location.search);
        let branches = urlParams.get('branches');
        if (document.getElementById('branches').value.trim() !== '') {
            branches = document.getElementById('branches').value;
        } else if (branches != null) {
            document.getElementById('branches').value = branches;
        }

        if (branches) {
            branches = branches.split(',').map(b => b.trim());
        }

        const yamls = [
            `${baseConfigURL}/serverless-operator.yaml`,
            `${baseConfigURL}/serving.yaml`,
            `${baseConfigURL}/eventing.yaml`,
            `${baseConfigURL}/eventing-kafka-broker.yaml`,
            `${baseConfigURL}/eventing-istio.yaml`,
            `${baseConfigURL}/eventing-integrations.yaml`,
            `${baseConfigURL}/client.yaml`,
            `${baseConfigURL}/kn-plugin-event.yaml`,
            `${baseConfigURL}/kn-plugin-func.yaml`,
            `${baseConfigURL}/serving-net-istio.yaml`,
            `${baseConfigURL}/serving-net-kourier.yaml`,
            `${baseConfigURL}/backstage-plugins.yaml`,
        ];

        const allConfigs = await Promise.all(
            yamls.flatMap(async (u) => {
                const yamlResp = await fetch(u + `?_=${Date.now()}`);
                const b = await yamlResp.text();
                const doc = jsyaml.load(b);

                return doc.repositories.flatMap(r => {
                    return Object.keys(doc.config.branches)
                        .filter(b => {
                            if (branches) return branches.includes(b);
                            return b !== "release-next";
                        })
                        .map(async (b) => {
                            const headers = document.getElementById("pat").value.trim() ? {
                                "Authorization": `Bearer ${document.getElementById("pat").value}`
                            } : {};

                            const res = await fetch(`https://api.github.com/repos/${r.org}/${r.repo}/commits/${b}/check-runs?per_page=100&_=${Date.now()}`, {
                                headers
                            });
                            const json = await res.json();

                            const latestCommit = json.check_runs?.[0]?.head_sha?.slice(0, 7) || '';
                            const lastSuccess = json.check_runs?.find(c => c.conclusion === 'success')?.head_sha?.slice(0, 7) || '';

                            return {
                                branch: b,
                                org: r.org,
                                repo: r.repo,
                                runs: json,
                                latestCommit,
                                lastSuccessCommit: lastSuccess
                            };
                        });
                });
            })
        );

        const flatConfigs = (await Promise.all(allConfigs.flat())).flat();

        const tableData = flatConfigs.flatMap(item => {
            return item.runs.check_runs
                .filter(run => run.name.includes('Konflux'))
                .map(run => {
                    const separator = run.name.indexOf('/');
                    let testName = run.name;
                    if (separator >= 0 && separator < run.name.length - 1) {
                        testName = run.name.slice(separator + 1).trim();
                    }

                    return [
                        item.branch,
                        item.repo,
                        run.name,
                        run.output?.title || run.conclusion,
                        new Date(run.started_at).toLocaleString(),
                        `<button onClick="retriggerTest('${item.org}', '${item.repo}', '${item.branch}', '${run.head_sha}', '${testName}')">retest</button>`,
                        `<a href="${run.html_url}" target="_blank">link</a>`,
                        item.latestCommit,
                        item.lastSuccessCommit
                    ];
                });
        });

        new DataTable('#build-status-table', {
            destroy: true,
            paging: false,
            data: tableData,
            columns: [
                { title: "Branch" },
                { title: "Repository" },
                { title: "Run Name" },
                { title: "Status" },
                { title: "Started" },
                { title: "Trigger retest" },
                { title: "Run" },
                { title: "Latest Commit" },
                { title: "Last Success Commit" }
            ],
            search: { search: '!-ec !-test-' }
        });
    });

    async function retriggerTest(org, repo, branch, commitSha, testName) {
        const url = `https://api.github.com/repos/${org}/${repo}/commits/${commitSha}/comments`;
        const token = document.getElementById("pat").value.trim();
        if (!token) { alert("Token required to retigger a run"); return; }

        const comment = `/retest ${testName} branch:${branch}`;
        try {
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ body: comment })
            });
            if (response.ok) alert("Run retriggered!");
            else {
                const text = await response.text();
                alert(`Failed to retrigger: ${text}`);
            }
        } catch (err) {
            console.error("Failed to retrigger:", err);
            alert(`Failed to retrigger: ${err}`);
        }
    }
</script>
</html>
